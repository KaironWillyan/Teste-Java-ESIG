<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

<ui:composition template="/template/template.xhtml">

  <ui:define name="head">
    <style>
      #formPrincipal .status-grid .labelCell {
        width: 160px;
        font-weight: 600;
        padding-right: 8px;
        white-space: nowrap;
      }
      #formPrincipal .status-grid .valueCell {
        width: auto;
      }
    </style>
  </ui:define>

  <ui:define name="content">

    <h:form id="formPrincipal">
      <p:growl id="messages" showDetail="true" autoUpdate="true" life="5000" />

      <h1>Gestão de Salários</h1>

      <p:panel header="Controles e Filtros">
        <p:toolbar>
          <p:toolbarGroup>
            <p:selectOneMenu id="filtroCargo" value="#{pessoaBean.filtroCargoId}" style="min-width:200px;margin-right:10px;">
              <f:selectItem itemLabel="Filtrar por Cargo" itemValue="#{null}" noSelectionOption="true"/>
              <f:selectItems value="#{pessoaBean.todosOsCargos}" var="cargo"
                             itemLabel="#{cargo.nome}" itemValue="#{cargo.id}"/>
              <p:ajax event="change" update="tabelaSalarios"/>
            </p:selectOneMenu>

            <p:inputText id="filtroNome" value="#{pessoaBean.filtroNome}" placeholder="Filtrar por Nome" style="margin-right:10px;"/>
            <p:commandButton id="btnBuscar" value="Buscar" update="tabelaSalarios" icon="pi pi-search"/>
          </p:toolbarGroup>
          
          <p:blockUI widgetVar="blkCalc" block="formPrincipal"
           trigger="btnCalcular btnCancelar" />

          <p:toolbarGroup align="right">
            <p:commandButton id="btnCalcular"
                             value="Calcular / Recalcular salários"
                             icon="pi pi-refresh"
                             onstart="PF('blkCalc').show()" oncomplete="PF('blkCalc').hide()"
                             actionListener="#{pessoaBean.iniciarRecalculoAsync}"
                             update="panelStatus tabelaSalarios btnCancelar btnCalcular pollWrapper"
                             disabled="#{pessoaBean.busy}" />

            <p:commandButton id="btnCancelar"
                             value="Cancelar"
                             icon="pi pi-stop"
                             onstart="PF('blkCalc').show()" oncomplete="PF('blkCalc').hide()"
                             actionListener="#{pessoaBean.cancelarRecalculo}"
                             update="panelStatus tabelaSalarios btnCancelar btnCalcular pollWrapper"
                             styleClass="ui-button-danger"
                             disabled="#{not pessoaBean.busy}" />
          </p:toolbarGroup>
        </p:toolbar>
      </p:panel>

      <p:panel id="panelStatus" header="Status do cálculo" style="margin-top:10px;">
        <h:panelGroup rendered="#{not empty pessoaBean.status}">
          <p:progressBar value="#{pessoaBean.status.progressPercent}" labelTemplate="{value}%"/>
          <p:panelGrid id="statusGrid" columns="2" styleClass="status-grid" columnClasses="labelCell,valueCell" style="margin-top:8px;">
            <h:outputText value="Estado:" />
            <h:outputText value="#{pessoaBean.status.state}" />
            <h:outputText value="Processados:" />
            <h:outputText value="#{pessoaBean.status.processed} / #{pessoaBean.status.total}" />
            <h:outputText value="Mensagem:" />
            <h:outputText value="#{pessoaBean.status.message}" />
          </p:panelGrid>
        </h:panelGroup>

        <h:panelGroup rendered="#{empty pessoaBean.status}">
          <h:outputText value="Nenhum job em execução." />
        </h:panelGroup>
      </p:panel>

      <h:panelGroup id="pollWrapper">
        <p:poll interval="1"
                listener="#{pessoaBean.onPollStatus}"
                update="panelStatus tabelaSalarios btnCancelar btnCalcular pollWrapper"
                rendered="#{pessoaBean.busy}" 
                global="false"/>
      </h:panelGroup>

      <h:panelGroup style="text-align:right; margin: 10px 0;">
      </h:panelGroup>

      <p:dataTable id="tabelaSalarios" var="salario" value="#{pessoaBean.lazyModel}"
                   lazy="true"
                   paginator="true" rows="10" paginatorPosition="bottom"
                   emptyMessage="Nenhum salário encontrado."
                   stripedRows="true" rowHover="true"
                   styleClass="ui-datatable-stripes ui-datatable-hover"
                   paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                   rowsPerPageTemplate="5,10,15,20,50"
                   currentPageReportTemplate="Exibindo {startRecord}-{endRecord} de {totalRecords}">
        <p:column headerText="Nome da Pessoa" sortBy="#{salario.nomePessoa}">
          <h:outputText value="#{salario.nomePessoa}" />
        </p:column>

        <p:column headerText="Cargo" sortBy="#{salario.nomeCargo}">
          <h:outputText value="#{salario.nomeCargo}" />
        </p:column>

        <p:column headerText="Salário" sortBy="#{salario.salario}" style="text-align:right;">
          <h:outputText value="#{salario.salario}">
            <f:convertNumber type="currency" currencySymbol="R$ " locale="pt_BR"/>
          </h:outputText>
        </p:column>
      </p:dataTable>
    </h:form>

    <h:form id="formRelatorio" target="_blank">
      <div style="text-align: right; margin-top: 10px;">
        <p:commandButton value="Gerar PDF" icon="pi pi-file-pdf"
                         actionListener="#{pessoaBean.gerarRelatorioPDF}"
                         ajax="false" styleClass="ui-button-danger" />
      </div>
    </h:form>

  </ui:define>
</ui:composition>
</html>
